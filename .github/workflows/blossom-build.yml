name: LineageOS 23 Blossom Build (Crave)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Install Crave CLI
      - name: Install Crave
        run: |
          curl -s https://raw.githubusercontent.com/accupara/crave/master/get_crave.sh | bash -s --

      # Write crave.conf safely (NO LOGGING!)
      - name: Write Crave Config
        run: |
          cat > $HOME/crave.conf <<'CRAVEFILE'
${{ secrets.CRAVE_CONF }}
CRAVEFILE

      # Start Crave Build
      - name: Start Crave Build
        run: |
          ./crave -c $HOME/crave.conf run --ams https://foss.crave.io --cmd "
          repo init -u https://github.com/LineageOS/android.git -b lineage-23.0

          mkdir -p .repo/local_manifests
          cat > .repo/local_manifests/blossom.xml <<'MANIFEST'
          <manifest>
            <project name='xiaomi-blossom-dev/device_xiaomi_blossom' path='device/xiaomi/blossom' remote='github' revision='main' />
            <project name='xiaomi-blossom-dev/proprietary_vendor_xiaomi_blossom' path='vendor/xiaomi/blossom' remote='github' revision='main' />
            <project name='xiaomi-blossom-dev/kernel_xiaomi_blossom' path='kernel/xiaomi/blossom' remote='github' revision='main' />
            <project name='LineageOS/android_device_mediatek_common' path='device/mediatek/common' remote='github' revision='lineage-23.0' />
          </manifest>
          MANIFEST

          repo sync -c --force-sync --no-clone-bundle --no-tags -j\$(nproc)

          source build/envsetup.sh
          lunch lineage_blossom-userdebug
          mka bacon
          "

      - name: Upload ROM
        uses: actions/upload-artifact@v4
        with:
          name: lineage-blossom-rom
          path: out/target/product/blossom/
