name: LineageOS 22.1 Blossom Build (Crave)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Crave
        run: |
          curl -s https://raw.githubusercontent.com/accupara/crave/master/get_crave.sh | bash -s --
          sudo mv crave /usr/local/bin/
          crave version || true

      - name: Restore crave.conf
        run: |
          echo "${{ secrets.CRAVE_CONF }}" | base64 -d > $HOME/crave.conf

      - name: Create Manifest Directory
        run: |
          mkdir -p .repo/local_manifests

      - name: Write Blossom Manifest
        run: |
          echo '<manifest>' > .repo/local_manifests/blossom.xml
          echo '  <project name="xiaomi-blossom-dev/device_xiaomi_blossom" path="device/xiaomi/blossom" remote="github" revision="main" />' >> .repo/local_manifests/blossom.xml
          echo '  <project name="xiaomi-blossom-dev/proprietary_vendor_xiaomi_blossom" path="vendor/xiaomi/blossom" remote="github" revision="main" />' >> .repo/local_manifests/blossom.xml
          echo '  <project name="xiaomi-blossom-dev/kernel_xiaomi_blossom" path="kernel/xiaomi/blossom" remote="github" revision="main" />' >> .repo/local_manifests/blossom.xml
          echo '</manifest>' >> .repo/local_manifests/blossom.xml

      - name: Build ROM on Crave
        env:
          CRAVE_NOUPDATE: 1
        run: |
          crave -n fullbuild 93

      - name: Upload ROM
        uses: actions/upload-artifact@v4
        with:
          name: blossom-rom
          path: out/target/product/blossom/*.zip
