name: LineageOS 23 Blossom Build (Crave)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Crave
        run: |
          curl -s https://raw.githubusercontent.com/accupara/crave/master/get_crave.sh | bash -s --

      - name: Write Crave Config
        run: |
          echo "${{ secrets.CRAVE_CONF }}" > $HOME/crave.conf

      - name: Create Build Script
        run: |
          echo '#!/bin/bash' > build.sh
          echo 'set -e' >> build.sh
          echo 'repo init -u https://github.com/LineageOS/android.git -b lineage-23.0' >> build.sh
          echo 'mkdir -p .repo/local_manifests' >> build.sh
          echo '<manifest>' > .repo/local_manifests/blossom.xml
          echo '  <project name="xiaomi-blossom-dev/device_xiaomi_blossom" path="device/xiaomi/blossom" remote="github" revision="main" />' >> .repo/local_manifests/blossom.xml
          echo '  <project name="xiaomi-blossom-dev/proprietary_vendor_xiaomi_blossom" path="vendor/xiaomi/blossom" remote="github" revision="main" />' >> .repo/local_manifests/blossom.xml
          echo '  <project name="xiaomi-blossom-dev/kernel_xiaomi_blossom" path="kernel/xiaomi/blossom" remote="github" revision="main" />' >> .repo/local_manifests/blossom.xml
          echo '  <project name="LineageOS/android_device_mediatek_common" path="device/mediatek/common" remote="github" revision="lineage-23.0" />' >> .repo/local_manifests/blossom.xml
          echo '</manifest>' >> .repo/local_manifests/blossom.xml
          echo 'repo sync -c --force-sync --no-clone-bundle --no-tags -j$(nproc)' >> build.sh
          echo 'source build/envsetup.sh' >> build.sh
          echo 'lunch lineage_blossom-userdebug' >> build.sh
          echo 'mka bacon' >> build.sh
          chmod +x build.sh

      - name: Start Crave Build
        run: |
          ./crave -c $HOME/crave.conf run -- bash build.sh

      - name: Upload ROM
        uses: actions/upload-artifact@v4
        with:
          name: lineage-blossom-rom
          path: out/target/product/blossom/
